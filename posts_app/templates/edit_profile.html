{% extends 'base.html' %}

{% block title %}Editar Perfil{% endblock %}

{% block content %}
<div class="edit-profile-container">
    <h1>Editar Perfil</h1>
    <form method="post" enctype="multipart/form-data" id="profile-form">
        {% csrf_token %}
        {{ form.as_p }}
        <button href="{"profile"}" type="submit" class="btn btn-success">Salvar</button>
    </form>

    <!-- Modal para corte de imagem -->
    <div id="cropper-modal" class="modal">
        <div class="modal-content">
            <h2>Corte sua imagem</h2>
            <div>
                <img id="image-to-crop" src="" alt="Imagem para cortar">
            </div>
            <button id="crop-image" class="btn btn-primary">Cortar Imagem</button>
            <button id="close-modal" class="btn btn-secondary">Fechar</button>
        </div>
    </div>
</div>

<!-- Estilos para a modal -->
<style>
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        width: 80%;
        max-width: 600px;
    }
    #image-to-crop {
        max-width: 100%;
        max-height: 400px;
    }
</style>

<!-- Adicionando o Cropper.js via CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
<script>
    let cropper;
    const imageInput = document.querySelector('input[type="file"]');
    const cropperModal = document.getElementById('cropper-modal');
    const imageToCrop = document.getElementById('image-to-crop');
    const cropButton = document.getElementById('crop-image');
    const closeModalButton = document.getElementById('close-modal');
    const profileForm = document.getElementById('profile-form');
    let croppedImageData = null;

    // Quando o usuário escolhe um arquivo
    imageInput.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
                imageToCrop.src = event.target.result;
                cropperModal.style.display = 'flex';

                // Inicializa o Cropper.js
                if (cropper) {
                    cropper.destroy(); // Se já existir um cropper, destrua antes de criar outro
                }
                cropper = new Cropper(imageToCrop, {
                    aspectRatio: 1, // Faz com que o corte seja quadrado
                    viewMode: 1, // Faz com que o corte não ultrapasse a área da imagem
                    autoCropArea: 0.5, // Define a área inicial de corte
                });
            };
            reader.readAsDataURL(file);
        }
    });

    // Cortar a imagem e adicionar ao formulário temporariamente
    cropButton.addEventListener('click', function () {
        const canvas = cropper.getCroppedCanvas();
        canvas.toBlob(function (blob) {
            const formData = new FormData();
            formData.append('cropped_image', blob, 'cropped_image.png');

            // Guarda a imagem temporária (sem salvar no banco de dados ainda)
            croppedImageData = formData;

            // Atualiza a imagem do perfil com a nova imagem cortada (visualmente)
            const imgElement = document.querySelector('.profile-icon img');
            const croppedImageURL = URL.createObjectURL(blob);
            imgElement.src = croppedImageURL;

            // Fechar a modal de corte
            cropperModal.style.display = 'none';
        });
    });

    // Fechar a modal sem fazer nada
    closeModalButton.addEventListener('click', function () {
        cropperModal.style.display = 'none';
        if (cropper) {
            cropper.destroy(); // Destroi o cropper ao fechar
        }
    });

    // Quando o formulário de edição for enviado, envia a imagem cortada
    profileForm.addEventListener('submit', function (e) {
        e.preventDefault(); // Impede o envio padrão

        // Adiciona a imagem cortada ao formulário
        if (croppedImageData) {
            const formData = new FormData(profileForm);
            formData.append('cropped_image', croppedImageData.get('cropped_image'));

            // Envia a imagem cortada junto com as demais edições do perfil
            fetch("{% url 'edit_profile' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            })
            .then(response => response.json())
            .then(data => {
                // Atualiza a imagem de perfil no banco de dados
                document.querySelector('.profile-icon img').src = data.new_image_url;
                // Redireciona ou atualiza a página de perfil
                window.location.href = '{% url "profile" %}'; // ou recarregar a página
            })
            .catch(error => console.error('Erro ao salvar a imagem cortada:', error));
        } else {
            // Caso não tenha cortado a imagem, envia o formulário normalmente
            profileForm.submit();
        }
    });
</script>


{% endblock %}
